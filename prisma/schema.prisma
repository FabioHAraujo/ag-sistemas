// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MEMBER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TargetAudience {
  ALL
  MEMBERS
  ADMINS
}

enum MeetingType {
  REGULAR
  SPECIAL
  ONE_ON_ONE
}

enum MeetingStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  LATE
}

enum ReferralStatus {
  SENT
  CONTACTED
  NEGOTIATING
  CLOSED_WON
  CLOSED_LOST
}

enum OneOnOneStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum PlanType {
  MONTHLY
  QUARTERLY
  ANNUAL
}

enum MembershipStatus {
  ACTIVE
  CANCELLED
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String     @map("password_hash")
  name         String
  role         Role       @default(MEMBER)
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  profile              MemberProfile?
  reviewedApplications Application[]        @relation("ApplicationReviewer")
  announcements        Announcement[]
  createdMeetings      Meeting[]
  attendances          MeetingAttendance[]
  sentReferrals        Referral[]           @relation("ReferralSender")
  receivedReferrals    Referral[]           @relation("ReferralReceiver")
  referralUpdates      ReferralUpdate[]
  givenThankYous       ThankYou[]           @relation("ThankYouSender")
  receivedThankYous    ThankYou[]           @relation("ThankYouReceiver")
  oneOnOneMeetingsAsOne OneOnOneMeeting[]   @relation("MemberOne")
  oneOnOneMeetingsAsTwo OneOnOneMeeting[]   @relation("MemberTwo")
  memberships          Membership[]
  payments             Payment[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Application {
  id             String            @id @default(uuid())
  name           String
  email          String
  company        String
  motivation     String
  status         ApplicationStatus @default(PENDING)
  reviewedBy     String?           @map("reviewed_by")
  reviewedAt     DateTime?         @map("reviewed_at")
  token          String?           @unique
  tokenExpiresAt DateTime?         @map("token_expires_at")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  reviewer User?          @relation("ApplicationReviewer", fields: [reviewedBy], references: [id])
  profile  MemberProfile?

  @@index([status])
  @@index([email])
  @@map("applications")
}

model MemberProfile {
  id                 String    @id @default(uuid())
  userId             String    @unique @map("user_id")
  applicationId      String?   @unique @map("application_id")
  phone              String?
  company            String
  position           String?
  companyDescription String?   @map("company_description")
  expertiseArea      String?   @map("expertise_area")
  linkedinUrl        String?   @map("linkedin_url")
  websiteUrl         String?   @map("website_url")
  profileImageUrl    String?   @map("profile_image_url")
  bio                String?
  joinedAt           DateTime  @default(now()) @map("joined_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id])

  @@map("member_profiles")
}

// ========================================
// COMUNICAÇÃO MODELS
// ========================================

model Announcement {
  id             String         @id @default(uuid())
  title          String
  content        String
  authorId       String         @map("author_id")
  priority       Priority       @default(NORMAL)
  targetAudience TargetAudience @default(ALL) @map("target_audience")
  published      Boolean        @default(false)
  publishedAt    DateTime?      @map("published_at")
  expiresAt      DateTime?      @map("expires_at")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([published, publishedAt])
  @@map("announcements")
}

model Meeting {
  id          String        @id @default(uuid())
  title       String
  description String?
  meetingDate DateTime      @map("meeting_date")
  location    String?
  type        MeetingType
  status      MeetingStatus @default(SCHEDULED)
  createdBy   String        @map("created_by")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  creator     User                @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  attendances MeetingAttendance[]

  @@index([meetingDate])
  @@map("meetings")
}

model MeetingAttendance {
  id          String           @id @default(uuid())
  meetingId   String           @map("meeting_id")
  memberId    String           @map("member_id")
  status      AttendanceStatus @default(ABSENT)
  checkedInAt DateTime?        @map("checked_in_at")
  notes       String?
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  member  User    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([meetingId, memberId])
  @@map("meeting_attendances")
}

// ========================================
// NEGÓCIOS MODELS
// ========================================

model Referral {
  id                     String         @id @default(uuid())
  fromMemberId           String         @map("from_member_id")
  toMemberId             String         @map("to_member_id")
  companyName            String         @map("company_name")
  contactName            String         @map("contact_name")
  contactEmail           String?        @map("contact_email")
  contactPhone           String?        @map("contact_phone")
  opportunityDescription String         @map("opportunity_description")
  estimatedValue         Float?         @map("estimated_value")
  status                 ReferralStatus @default(SENT)
  closedValue            Float?         @map("closed_value")
  closedAt               DateTime?      @map("closed_at")
  notes                  String?
  createdAt              DateTime       @default(now()) @map("created_at")
  updatedAt              DateTime       @updatedAt @map("updated_at")

  fromMember User             @relation("ReferralSender", fields: [fromMemberId], references: [id], onDelete: Cascade)
  toMember   User             @relation("ReferralReceiver", fields: [toMemberId], references: [id], onDelete: Cascade)
  updates    ReferralUpdate[]
  thankYous  ThankYou[]

  @@index([status])
  @@index([fromMemberId])
  @@index([toMemberId])
  @@map("referrals")
}

model ReferralUpdate {
  id             String   @id @default(uuid())
  referralId     String   @map("referral_id")
  previousStatus String   @map("previous_status")
  newStatus      String   @map("new_status")
  updatedBy      String   @map("updated_by")
  comment        String?
  createdAt      DateTime @default(now()) @map("created_at")

  referral Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  updater  User     @relation(fields: [updatedBy], references: [id], onDelete: Cascade)

  @@map("referral_updates")
}

model ThankYou {
  id            String    @id @default(uuid())
  fromMemberId  String    @map("from_member_id")
  toMemberId    String    @map("to_member_id")
  referralId    String?   @map("referral_id")
  message       String
  businessValue Float?    @map("business_value")
  isPublic      Boolean   @default(true) @map("is_public")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  fromMember User      @relation("ThankYouSender", fields: [fromMemberId], references: [id], onDelete: Cascade)
  toMember   User      @relation("ThankYouReceiver", fields: [toMemberId], references: [id], onDelete: Cascade)
  referral   Referral? @relation(fields: [referralId], references: [id])

  @@map("thank_yous")
}

model OneOnOneMeeting {
  id           String         @id @default(uuid())
  memberOneId  String         @map("member_one_id")
  memberTwoId  String         @map("member_two_id")
  meetingDate  DateTime       @map("meeting_date")
  location     String?
  status       OneOnOneStatus @default(SCHEDULED)
  notes        String?
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  memberOne User @relation("MemberOne", fields: [memberOneId], references: [id], onDelete: Cascade)
  memberTwo User @relation("MemberTwo", fields: [memberTwoId], references: [id], onDelete: Cascade)

  @@map("one_on_one_meetings")
}

// ========================================
// FINANCEIRO MODELS
// ========================================

model Membership {
  id        String           @id @default(uuid())
  memberId  String           @map("member_id")
  planType  PlanType         @default(MONTHLY) @map("plan_type")
  amount    Float
  startDate DateTime         @map("start_date")
  endDate   DateTime?        @map("end_date")
  status    MembershipStatus @default(ACTIVE)
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  member   User      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@map("memberships")
}

model Payment {
  id            String        @id @default(uuid())
  membershipId  String        @map("membership_id")
  memberId      String        @map("member_id")
  amount        Float
  dueDate       DateTime      @map("due_date")
  paidAt        DateTime?     @map("paid_at")
  status        PaymentStatus @default(PENDING)
  paymentMethod String?       @map("payment_method")
  transactionId String?       @map("transaction_id")
  notes         String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  membership Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  member     User       @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([dueDate])
  @@map("payments")
}
